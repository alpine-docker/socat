# This pipeline will trigger on every PR change as well as for new tags
pr:
  autoCancel: true

trigger:
  tags:
    include: ['v*.*.*']

variables:
  - group: global-variables

stages:
- stage: build
  displayName: "Stage: Build"

  jobs:
  - job: Build
    pool: shared
    workspace:
      clean: all

    steps:

    - script: make build
      displayName: "Build image"

  - job: Test
    pool: shared
    workspace:
      clean: all

    steps:

    - script: make test
      displayName: "Test image"

  - job: Scan
    pool: shared
    workspace:
      clean: all

    steps:

    - script: make twistscan
      env:
        TWISTLOCK_USER: $(TWISTLOCK_USER)
        TWISTLOCK_PASS: $(TWISTLOCK_PASS)
      displayName: "Scan image"


- ${{ if startsWith(variables['build.sourceBranch'], 'refs/tags/') }}:
  - stage: release
    displayName: "Stage: Release"
    dependsOn: build

    jobs:
    - job: Release
      pool: shared
      workspace:
        clean: all

      steps:

      - script: make release
        displayName: "Release image"


- ${{ if startsWith(variables['build.sourceBranch'], 'refs/tags/') }}:
  - stage: runtime
    displayName: "Stage: Runtime Test"
    dependsOn: release

    jobs:
    - job: Runtime
      pool: shared
      workspace:
        clean: all

      steps:

      - script: make testruntime
        displayName: "Perform runtime test"
