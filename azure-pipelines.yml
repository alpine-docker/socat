# This will fire for every PR on as well as tags.
# Docker push and deployment to DEV will happen for commits to `master` branch or tags.
pr:
  autoCancel: true

trigger:
  tags:
    include: ['v*.*.*']

variables:
  - group: global-variables

resources:
  repositories:
    - repository: templates
      type: github
      endpoint: mx51
      name: mx51/azure-cicd-templates
      ref: refs/heads/master

stages:
  - template: msp-be-pipeline.yml@templates
    parameters:
      componentName: alpine-socat
      dockerRepository: mx51io
      #accountClasses: [cde, main]
      #deploymentRef: 'refs/heads/master'
      preventDeployment: true
      imageTag: $(Build.BuildNumber)
      twistlockPassword: $(TWISTLOCK_PASSWORD)
      dockerfilePath: Dockerfile
      runHelmKubeval: false
      runCheckDeps: false
      runCheckPackr: []
      runUnitTest: false
      runCodeAnalysis: false
      runCodeCoverage: false
      runDBMigration: false
      runE2ETests: false
      runSnykVulnScan: false
      category: ops
      deployVersionURL: https://github.com/mx51/pi-alpine-socat/releases

      # Additional build-stage testing steps
      steps:
      - script: make testruntime
        displayName: "Socat tunnel runtime test"

  # Separate stage: test
  - stage: test
    displayName: "Stage: Test"
    jobs:
    - job: Test
      pool: shared
      steps:

      # This does not work unless `make release` is performed on v*.*.* tag trigger
      - script: echo make testruntime
        displayName: "Socat tunnel runtime test"
